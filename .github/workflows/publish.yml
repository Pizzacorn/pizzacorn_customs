name: Publish to pub.dev on push

on:
  push:
    branches:
      - master           # cÃ¡mbialo si tu rama principal no es main
    paths:
      - 'pubspec.yaml'
      - 'lib/**'
      - 'README.md'
      - 'CHANGELOG.md'
      - 'LICENSE'
  workflow_dispatch:    # por si quieres lanzarlo a mano tambiÃ©n

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Flutter pub get
        run: flutter pub get

      - name: Set pub.dev credentials
        run: |
          mkdir -p ~/.pub-cache
          echo "$PUB_CREDENTIALS" > ~/.pub-cache/credentials.json
        env:
          PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}

      - name: Show version from pubspec
        run: |
          VERSION=$(grep -E "^version:" pubspec.yaml | awk '{print $2}')
          echo "ðŸ“¦ Version in pubspec.yaml: $VERSION"

      - name: Dry run
        run: dart pub publish --dry-run

      # Publica siempre en cada push; si la versiÃ³n ya existe, no falla el job.
      - name: Publish to pub.dev (skip if already exists)
        run: |
          set +e
          OUTPUT=$(dart pub publish --force 2>&1)
          EXIT=$?
          echo "$OUTPUT"
          if [ $EXIT -ne 0 ] && echo "$OUTPUT" | grep -qi "already exists"; then
            echo "âœ… Version ya publicada en pub.dev. Se omite sin fallar."
            exit 0
          fi
          exit $EXIT
